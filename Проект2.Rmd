
---
title: "Проект 2"
author: "Группа 12"
date: "2023-11-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```
Загрузим библиотеки для анализа данных:
```{r libraries}
library(knitr)# для красивой таблицы
library(ggplot2) #для графиков боксплот
library(dplyr)
library(performance)
```
Импортируем данные:
```{r}
main_dir <- dirname(rstudioapi::getSourceEditorContext()$path) 
setwd(main_dir)
soybean <- read.csv("soybean.csv")
```
### EDA (Exploratory data analysis)
## Оценим структуру данных

Данный датасет содержит информацию о полевых испытаниях ~300 сортов (id) сои в 2 локациях в течение 5 лет. 
Переменные:
-productivity (г/м^2)
-oil_content (%)
-protein_content (%) 
-vegetation_period (время в днях от всхода до сбора) 
-leaf_shape: форма листьев 
-maturation_group: группа созревания (чем больше, тем более позднеспелый) 
-flowering_group: группа цветения
-pubescence_colour: цвет опушения
-corolla_colour: цвет венчика 
-origin: страна происхождения полегание 
-lodging_type: полегание
-growth_type:тип роста (индетерминантный - цветёт до сбора, детерминантный - цветёт один раз)
```{r cars}
summary(soybean)
```
Приведем данные к соответствующим типам (категориальные переменные из character в factor):
```{r}
soybean$leaf_shape <- as.factor(soybean$leaf_shape)
soybean$corolla_colour <- as.factor(soybean$corolla_colour)
soybean$maturation_group <- as.factor(soybean$maturation_group)
soybean$flowering_group <- as.factor(soybean$flowering_group)
soybean$year <- as.factor(soybean$year)
soybean$origin <- as.factor(soybean$origin)
soybean$growth_type <- as.factor(soybean$growth_type)
soybean$maturation_group <- as.factor(soybean$maturation_group)
soybean$lodging_type <- as.factor(soybean$lodging_type)
soybean$pubescence_colour <- as.factor(soybean$pubescence_colour)
soybean$site <- as.factor(soybean$site)
```
Посмотрим на пропущенные значения:
```{r data import}
na_counts <- sapply(soybean, function(x) sum(is.na(x)))
na_counts_df <- data.frame(Column=names(na_counts), NA_Count=na_counts)
rownames(na_counts_df) <- NULL
kable(na_counts_df, "pipe", caption = "Количество NA по столбцам")
```
Высчитаем долю NA значений: #надо или убрать или сделать красивый вывод
```{r data import}
sum(is.na(soybean$productivity))/length(soybean$productivity) #0.52 (52% составляют NA)
sum(is.na(soybean$vegetation_period))/length(soybean$vegetation_period) #0.52
sum(is.na(soybean$protein_content))/length(soybean$protein_content) #0.57 (57% составляют NA)
sum(is.na(soybean$oil_content))/length(soybean$oil_content) #0.57
```

Положения NA в колонках productivity и vegetation_period совпадают.
Положения NA в колонках protein_content и oil_content совпадают.
(это про что?)

В связи с большим количеством наблюдений и неинформативности строк с пропущенными значениями:
уберем пропущенные значения.
```{r data import}
soybean_no_na <- na.omit(soybean)
```
Посмотрим на выбросы в данных:
```{r data import}

boxplot(soybean_no_na$productivity,
        col = rgb(1, 0, 0, alpha = 0.4),
        xlab = "Продуктивность")
boxplot(soybean_no_na$vegetation_period,
        col = "thistle",
        xlab = "Вегетационный период")
boxplot(soybean_no_na$protein_content,
        col = "skyblue",
        xlab = "Содержание белка")
boxplot(soybean_no_na$oil_content,
        col = "sandybrown",
        xlab = "Содержание жира")
```

Общий вывод:
Нашей группой было решено убрать пропущенные значения. Выбросы мы решили не убирать, так как возможно они не случайны и их стоить включить в модель для предсказания величин. 

### Проверка гипотез
# Влияние группы созревания на содержание белка в сое

Соя является одним из наиболее популярных и распространенных источников растительного белка, широко используемым в пищевой и фармацевтической промышленности.Изучение влияния группы созревания на содержание белка в сое может помочь подобрать наиболее питательные и эффективные сорта сои для производства пищевых продуктов. Разные стадии созревания сои могут оказывать влияние на ее белковый профиль и содержание конкретных аминокислот. Исследование влияния группы созревания на содержание белка в сое может помочь определить оптимальное время сбора урожая и обрабатывать сою в наиболее благоприятных сроках, чтобы получить максимальное содержание белка и наилучшую пищевую ценность.

Для выявления отличий между группами созревания в количестве белка в сое проведём ANOVA.
Нулевая гипотеза - образцы во всех группах взяты из популяций с одинаковыми средними (то есть различий нет)
```{r data import}
result_maturation_protein <- aov(protein_content ~ maturation_group,data = soybean_no_na)
summary(result_maturation_protein)
```
P-value меньше 0.05 значит мы можем отвергнуть нулевую гипотезу, если допущения проведения ANOVA верны. Проверим допущения ANOVA.
Проведем проверку на нормальное распределения остатков:
```{r data import}
check_normality(result_maturation_protein)
```
Видим, что остатки распределены не нормально, значит в этом случае нам нужен непараметрический аналог Anova - критерий Краскела — Уоллиса:
```{r data import}
kruskal.test(protein_content ~ maturation_group,data = soybean_no_na)
```
В этом случае P-value оказался также меньше 0.05 значит мы можем отвергнуть нулевую гипотезу и различия между группами созревания в количестве белка есть.
Для того, чтобы использовать тест Краскела - Уоллиса формы распределений данных в каждой группе должны совпадать проверим это допущение:

```{r data import}
ggplot(soybean_no_na, aes(x=protein_content, color=maturation_group)) +
    geom_density(alpha=0.3) +
    labs(title="Распределения данных в группах созревания")
```
По графику видно, что данные в каждой группе созревания распределены примерно похожим образом, значит мы можем доверять результатам теста Краскела-Уоллиса.
Так как мы использовали непараметрический критерий для замены Anova, то и для поиска различий между группами должны применить непараметрический критерий, например, Вилкоксона 
```{r data import}
maturation_protein <- pairwise.wilcox.test(soybean_no_na$protein_content,soybean_no_na$maturation_group , p.adjust.method = "bonferroni")
print(maturation_protein)
```
Визуализируем получившиеся различия:
```{r data import}
soybean_no_na %>%
  ggplot(aes(x=maturation_group, y=protein_content, color=maturation_group)) +
  geom_boxplot()+
  geom_jitter(width=0.15, alpha=0.5)+
  scale_y_log10()+
  labs(x="Группа созревания", y= "Количество белка") +
  labs(subtitle="Сравнение групп созревания по количеству белка")
  scale_x_discrete(guide = guide_axis(n.dodge=2))+
  theme(legend.position="none")

```

Вывод:
Таким образом, были обнаружены значимые различия между группами созревания: 1 и 2, 1 и 3, 2 и 4, 2 и 5, 3 и 4, 3 и 5. Между 1, 4 и 5 группами значимых отличий обнаружено не было. Таким образом, можно сказать, что чем более позднеспелым является растение, тем выше содержание белка в сое. При этом если растение относится к группе раннеспелых 1, то оно также показывает высокое содержание белка. Что может быть обусловлено генетическими особенностями, условиями выращивания или другими факторами. Однако, необходимо провести дополнительные исследования для более точного определения причин этого явления.

# Выявление наиболее продуктивного сорта сои 

Далее мы решили проверить и узнать какой сорт наиболее продуктивный простым сравнением средних. 
```{r data import}

# Группировка по 'id' и вычисление средней продуктивности для каждого сорта
mean_productivity <- soybean_no_na %>%
  group_by(id) %>%
  summarise(mean_productivity = mean(productivity, na.rm = TRUE)) %>%
  arrange(desc(mean_productivity))

# Вывод средних значений продуктивности для каждого сорта
print(mean_productivity)

# Выбор сорта с наибольшей средней продуктивностью
most_productive <- mean_productivity[which.max(mean_productivity$mean_productivity), ]
print(most_productive)

```
В данном случае получается, что наиболее продуктивный сорт - сорт под индексом 275.

Но проверим еще с помощью дисперсионного анализа
```{r data import}
anova_results <- anova(model, test = "F")
print(anova_results)
```
В результате получаем, что наиболее важными показателями являются id, oil_content, protein_content и vegetation_period
Поэтому именно их и будем учитывать в модели. 
```{r data import}
model <- aov(productivity ~ id + oil_content + protein_content + vegetation_period, data = soybean_no_na)
anova_results <- anova(model, test = "F")
# Демонстрируем результаты ANOVA, после чего смотрим продуктивность в зависимости от многих факторов
print(anova_results)
mean_productivity <- aggregate(productivity ~ id + oil_content + protein_content + vegetation_period, data = soybean_no_na, FUN = mean)

# Ищем сорт с наибольшей средней продуктивностью
most_productive_sort <- mean_productivity[which.max(mean_productivity$productivity), ]

# Выведим информацию о наиболее продуктивном сорте
print(most_productive_sort)
```
Вывод: 165 сорт 

